<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIntelMatrix | Threat Intelligence Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>

    <!-- App Layout Wrapper -->
    <div class="app-layout">

        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="nav-group-title">DASHBOARD & ANALYTICS</div>
            <a href="#" class="nav-item active" data-target="dashboard-view">
                <span>Coverage Matrix</span>
            </a>
            <a href="#" class="nav-item" data-target="risk-heatmap-view">
                <span>Risk Heatmap</span>
            </a>
            <a href="#" class="nav-item" data-target="bubble-plot-view">
                <span>Technique Trends</span>
            </a>
            <a href="#" class="nav-item" data-target="threat-layers-view">
                <span>Threat Layers</span>
            </a>

            <div class="nav-group-title">AI & INTELLIGENCE</div>
            <a href="#" class="nav-item" data-target="ai-agent-view">
                <span>AI Agent</span>
            </a>
            <a href="#" class="nav-item" data-target="analysis-tools-view">
                <span>Analysis Tools</span>
            </a>

            <div class="nav-group-title">MANAGEMENT</div>
            <a href="#" class="nav-item" data-target="management-view">
                <span>System Data</span>
            </a>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-column" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">

            <!-- Top Header -->
            <header class="top-header">
                <div class="branding">
                    <strong>AIntelMatrix</strong> <span>Dashboard</span>
                </div>
                <div style="margin-left: auto;">
                    <!-- Placeholder for user profile or settings -->
                </div>
            </header>

            <!-- Scrollable Content -->
            <main class="main-content">

                <!-- VIEW: Coverage Matrix (Dashboard) -->
                <div id="dashboard-view" class="content-view active">
                    <div class="card">
                        <h2 class="card-title">ATT&CK Coverage Matrix</h2>
                        <div class="flex-row mb-4">
                            <button id="export-matrix-csv-btn" class="btn btn-secondary">Export CSV</button>
                        </div>
                        <div id="stats" class="mb-4">Calculating coverage...</div>
                        <div class="matrix-container" id="attack-matrix-container">
                            <div id="loadingIndicator" style="padding: 24px; text-align: center;">
                                <div class="loader"></div> Loading Matrix...
                            </div>
                            <div class="matrix" id="attack-matrix"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Risk Heatmap -->
                <div id="risk-heatmap-view" class="content-view">
                    <div class="card">
                        <h2 class="card-title">Risk-Based Heatmap</h2>
                        <p class="card-description">
                            Visualize risk based on threat group activity vs. detection coverage.<br>
                            <span style="color: var(--danger-red);">Red: High Risk</span> (Threat uses, No detection) |
                            <span style="color: #f39c12;">Orange: Medium Risk</span> (Threat uses, Detected) |
                            <span style="color: var(--accent-green);">Green: Low Risk</span> (No threat uses, Detected)
                        </p>
                        <div class="mb-4">
                            <button id="generate-heatmap-btn" class="btn btn-primary">Generate Risk Map</button>
                        </div>
                        <div class="matrix-container" id="heatmap-matrix-container">
                            <div id="heatmapLoading" class="hidden" style="padding: 24px; text-align: center;">
                                Processing...</div>
                            <div class="matrix" id="heatmap-matrix"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Bubble Plot -->
                <div id="bubble-plot-view" class="content-view">
                    <div class="card">
                        <h2 class="card-title">Technique Likelihood Trends</h2>
                        <p class="card-description">Most frequent techniques across loaded threat layers.</p>
                        <div class="mb-4">
                            <button id="generate-bubble-plot-btn" class="btn btn-primary">Generate Plot</button>
                        </div>
                        <div id="bubble-plot-container" style="text-align: center;">
                            <div id="bubble-plot-loading" class="hidden">Generated Plot...</div>
                            <svg id="bubble-plot-svg"></svg>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Threat Layers -->
                <div id="threat-layers-view" class="content-view">
                    <div class="card">
                        <h2 class="card-title">Threat Group Layers</h2>
                        <div class="flex-row mb-4">
                            <!-- File Input Label as Button -->
                            <label for="navigator-file-input" class="btn btn-primary">
                                Load Layer File(s)
                            </label>
                            <input type="file" id="navigator-file-input" accept=".json" multiple class="hidden">

                            <button id="clear-layers-btn" class="btn btn-secondary"
                                style="color: var(--danger-red); border-color: var(--danger-red);">Clear All</button>
                        </div>
                        <ul id="layer-list" style="list-style: none; padding: 0;"></ul>
                    </div>
                </div>

                <!-- VIEW: AI Agent -->
                <div id="ai-agent-view" class="content-view">
                    <div class="card">
                        <h2 class="card-title">AI Security Assistant</h2>
                        <p class="card-description">Ask questions about MITRE ATT&CK or your uploaded data.</p>

                        <div style="margin-bottom: 16px;">
                            <label
                                style="display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 14px;">
                                <input type="checkbox" id="useUserDataCheckbox">
                                Include User Knowledge Base (Docs/URLs/GitHub)
                            </label>
                        </div>

                        <div class="mb-4">
                            <textarea id="ai-query-input" rows="4"
                                placeholder="e.g. How does APT29 use PowerShell? Summary of dashboard status?"></textarea>
                        </div>
                        <div class="mb-4" style="text-align: right;">
                            <button id="send-ai-query-btn" class="btn btn-primary">Ask AI</button>
                        </div>

                        <div id="ai-loading" class="hidden mb-4" style="color: var(--primary-color);">Thinking...</div>
                        <div id="ai-response-area"></div>
                    </div>
                </div>

                <!-- VIEW: Analysis Tools -->
                <div id="analysis-tools-view" class="content-view">

                    <!-- Document Analysis Card -->
                    <div class="card">
                        <h2 class="card-title">Document Analysis</h2>
                        <p class="card-description">Upload .docx/.pdf to extract IoCs and Techniques.</p>
                        <div class="mb-4">
                            <label for="documentUpload" class="btn btn-primary">Upload Document(s)</label>
                            <input type="file" id="documentUpload" accept=".docx,.pdf" multiple class="hidden">
                        </div>
                        <div id="doc-analysis-loading" class="hidden">Analyzing...</div>
                        <ul id="doc-analysis-results"></ul>
                    </div>

                    <!-- URL Analysis Card -->
                    <div class="card">
                        <h2 class="card-title">URL Analysis</h2>
                        <textarea id="url-input" rows="3" placeholder="Enter URLs (one per line)"></textarea>
                        <div class="mt-4 mb-4">
                            <button id="analyze-url-btn" class="btn btn-primary">Analyze URLs</button>
                        </div>
                        <div id="url-analysis-loading" class="hidden">Scanning...</div>
                        <div id="url-analysis-results"></div>
                    </div>

                    <!-- GitHub Analysis Card -->
                    <div class="card">
                        <h2 class="card-title">GitHub Repository Scanner</h2>
                        <textarea id="github-repo-input" rows="3"
                            placeholder="Enter Repo URLs (e.g., https://github.com/owner/repo)"></textarea>
                        <div class="mt-4 mb-4">
                            <button id="analyze-github-repo-btn" class="btn btn-primary">Scan Repos</button>
                        </div>
                        <div id="github-repo-analysis-loading" class="hidden">Cloning & Scanning...</div>
                        <div id="github-repo-analysis-results"></div>
                    </div>

                </div>

                <!-- VIEW: Management -->
                <div id="management-view" class="content-view">

                    <div class="card">
                        <h2 class="card-title">Knowledge Base Data</h2>
                        <p class="card-description">View all ingested content available to the AI.</p>
                        <button id="showUserDataBtn" class="btn btn-secondary">View All Data</button>
                    </div>

                    <div class="card">
                        <h2 class="card-title">OS Distribution</h2>
                        <p class="card-description">Target OS analysis based on searches.</p>
                        <div id="os-dist-loading">Loading...</div>
                        <ul id="os-dist-list"></ul>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Untagged Searches</h2>
                        <div class="flex-row mb-4">
                            <button id="export-missing-csv-btn" class="btn btn-secondary">Export Report</button>
                        </div>
                        <div id="missing-tags-loading">Loading...</div>
                        <ul id="missing-tags-list"></ul>
                    </div>

                </div>

            </main>
        </div>
    </div>

    <!-- Modals (Retained & Styled via CSS) -->

    <!-- Technique Details Modal -->
    <div id="technique-details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-technique-name">Technique Details</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div id="modal-coverage-content" style="padding: 24px;"></div>
        </div>
    </div>

    <!-- OS Search Modal -->
    <div id="os-search-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="os-modal-title">OS Search Details</h2>
                <div style="margin-left: auto;">
                    <button id="os-modal-export-csv" class="btn btn-secondary btn-sm">Export CSV</button>
                    <span class="modal-close-btn" style="margin-left: 12px;">&times;</span>
                </div>
            </div>
            <div id="os-modal-content" style="padding: 24px; max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Analysis Results Modal -->
    <div id="analysis-results-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="analysis-modal-title">Analysis Results</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div id="analysis-modal-body" style="padding: 24px; max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- User Data Modal -->
    <div id="userDataModal" class="modal-overlay hidden">
        <div class="modal-content" style="width: 800px; max-width: 90%;">
            <div class="modal-header">
                <h2 id="userDataModalTitle" class="modal-title">All Uploaded Data</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div id="userDataContent"
                style="padding: 24px; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; background: #f8f9fa;">
            </div>
            <p id="userDataStatus" style="padding: 10px 24px; color: var(--text-secondary);"></p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>

</html>